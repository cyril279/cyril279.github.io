<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>fileshare</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><h1 id="file-sharing">File Sharing</h1>
<p><a href="#samba">Samba</a><br>
<a href="#nfs">NFS</a><br>
<a href="#acl-setup">ACL</a><br>
<a href="#group-manipulation-notes">Notes</a></p>
<h1 id="samba">Samba</h1>
<h3 id="windows-to-nix-fileshare-protocol">Windows to *nix fileshare protocol</h3>
<h3 id="server">Server:</h3>
<p><strong>Install</strong><br>
<code>dnf install samba samba-client samba-common</code></p>
<p><strong>Configure</strong><br>
(backup original conf file)<br>
/etc/samba/smb.conf</p>
<pre><code>netbios name = dubserv
hosts allow = 127.0.0.1 192.168.9.0/24
workgroup = WORKGROUP
add/configure share entry(ies)
[dubstuff]
    comment = media 640 as ext4
    path = /storage/dubstuff
    valid users = @royalty
    create mask = 0775
    create mode = 0775
    browsable = yes
    writable = yes
    read only = no

[media]
    comment = media 3tb as ntfs
    path = /storage/share
    valid users = @smbgrp,@guests,@royalty
    browsable = yes
    writable = yes
    read only = no
</code></pre>
<p><strong>Configure firewall to allow samba service</strong><br>
<code>firewall-cmd --permanent --add-service=samba</code><br>
<code>firewall-cmd --permanent --add-service=samba-client</code><br>
<code>firewall-cmd --reload</code></p>
<p><strong>SEManage the shared directory</strong><br>
<code>dnf install policycoreutils-python-utils</code><br>
<code>semanage fcontext -a -t samba_share_t '/path/to/goods(/.*)?'</code><br>
<code>restorecon -Rv /path/to/goods</code></p>
<p><strong>If shared volume is NTFS partition: edit NTFS fstab entry</strong><br>
<code>context=system_u:object_r:samba_share_t:s0</code></p>
<h4 id="users-groups--permissions">Users, groups, &amp; permissions</h4>
<p><strong>User:</strong><br>
<code>groupadd smbgrp</code> #Create a new group<br>
<code>usermod -a -G smbgrp cyril</code> #add secondary group to existing user<br>
<code>useradd cyril -G smbgrp</code> #Create a new user &amp; add to smbgrp<br>
<code>smbpasswd -ae cyril</code> #Create (&amp; enable) a Samba password for the user</p>
<p><strong>Filesystem:</strong><br>
<code>chmod -R 0770 /path/to/goods</code> #Change the permissions of the folder<br>
<code>chown -R root:smbgrp /path/to/goods</code> #Change the ownership of the folder</p>
<p><strong>Test the newly saved entry &amp; restart samba services</strong><br>
<code>testparm</code><br>
<code>systemctl restart smb nmb</code></p>
<p><strong>Works? then enable both smb &amp; nmb services</strong><br>
<code>systemctl enable smb nmb</code></p>
<p><strong>nmb service is avc denied when selinux is enforcing ?</strong><br>
<code>ausearch -c 'nmbd' --raw | audit2allow -M my-nmbd</code><br>
<code>semodule -i my-nmbd.pp</code><br>
<code>systemctl restart nmb</code></p>
<h1 id="nfs">NFS</h1>
<h3 id="nix-to-nix-fileshare-protocol">nix to *nix fileshare protocol</h3>
<h4 id="nfs-share-setup-performed-on-fedora-29-server--client">nfs-share setup, Performed on Fedora 29 server &amp; client</h4>
<h3 id="server-1">Server:</h3>
<p><strong>Install</strong><br>
<code>dnf -y install nfs-utils rpcbind</code></p>
<p><strong>find (or create) domain name, for use in /etc/idmap.conf</strong><br>
<code>hostname -d</code> #returns domain name if present<br>
<code>hostnamectl set-hostname frip.frop</code> #sets host-name to frip, and domain-name to frop</p>
<p><strong>/etc/idmapd.conf</strong></p>
<pre><code># line 5: uncomment and change to your domain name
Domain = frop
</code></pre>
<p><strong>Configure what is exported, and with-whom to share</strong></p>
<p><strong>/etc/exports:</strong><br>
<code>/storage/share 192.168.0.0/24(rw,sync,subtree_check)</code><br>
<code>/storage/share 192.168.1.0/24(rw,sync,subtree_check)</code></p>
<p><strong>start (&amp; enable) the service(s)</strong><br>
<code>systemctl start nfs-server rpcbind rpc-statd nfs-idmapd</code><br>
<code>systemctl enable nfs-server rpcbind</code></p>
<p><strong>Configure firewall to allow client servers to access NFS shares</strong><br>
<code>firewall-cmd --permanent --add-service nfs</code><br>
<code>firewall-cmd --permanent --add-service mountd</code><br>
<code>firewall-cmd --permanent --add-service rpc-bind</code><br>
<code>firewall-cmd --reload</code></p>
<p><strong>see shares export correctly</strong><br>
<code>exportfs -rav</code></p>
<h3 id="client">Client:</h3>
<p>define server host-name&amp;ip in /etc/hosts?<br>
<strong>install</strong><br>
<code>dnf -y install nfs-utils rpcbind</code></p>
<p><strong>/etc/idmapd.conf</strong></p>
<pre><code># line 5: uncomment and change to your domain name
Domain = home
</code></pre>
<p><strong>start (&amp; enable) the service</strong><br>
<code>systemctl start rpcbind</code><br>
<code>systemctl enable rpcbind</code></p>
<p><strong>show available mounts from server (must specify server)</strong><br>
<code>showmount -e 192.168.0.13</code></p>
<p><strong>append nfs entry to /etc/fstab</strong></p>
<pre><code>(ip OR alias)
dubserv:/storage/share /storage/share                       nfs     defaults        0 0
192.168.0.13:/storage/share /storage/share               nfs     defaults        0 0
</code></pre>
<p>**<a href="https://www.itzgeek.com/how-tos/linux/centos-how-tos/how-to-setup-nfs-server-on-centos-7-rhel-7-fedora-22.html">https://www.itzgeek.com/how-tos/linux/centos-how-tos/how-to-setup-nfs-server-on-centos-7-rhel-7-fedora-22.html</a><br>
<a href="https://www.server-world.info/en/note?os=Fedora_28&amp;p=nfs&amp;f=1">https://www.server-world.info/en/note?os=Fedora_28&amp;p=nfs&amp;f=1</a><br>
<a href="https://www.server-world.info/en/note?os=Fedora_28&amp;p=nfs&amp;f=2">https://www.server-world.info/en/note?os=Fedora_28&amp;p=nfs&amp;f=2</a><br>
<a href="https://linuxconfig.org/how-to-configure-a-nfs-file-server-on-ubuntu-18-04-bionic-beaver#h7-2-configure-your-exports">https://linuxconfig.org/how-to-configure-a-nfs-file-server-on-ubuntu-18-04-bionic-beaver#h7-2-configure-your-exports</a><br>
<a href="https://www.tecmint.com/how-to-setup-nfs-server-in-linux/">https://www.tecmint.com/how-to-setup-nfs-server-in-linux/</a><br>
<a href="https://blackcatsoftware.us/fedora-27-configure-nfs-server-and-client/">https://blackcatsoftware.us/fedora-27-configure-nfs-server-and-client/</a></p>
<p>domain name info:<br>
<a href="https://www.lifewire.com/everything-you-need-to-know-about-the-domainname-command-4066531">https://www.lifewire.com/everything-you-need-to-know-about-the-domainname-command-4066531</a></p>
<p>gvfs-nfs<br>
nfs://dubserv.home:/storage/share</p>
<h1 id="acl-setup">ACL setup:</h1>
<p><strong>check for acl support in kernel</strong><br>
<code>grep -i acl /boot/config*</code></p>
<p><strong>install/verify required packages</strong><br>
<code>dnf install nfs4-acl-tools acl libacl</code></p>
<p><strong>set the directory privileges [[does not affect existing files]]</strong></p>

<table>
<thead>
<tr>
<th align="center">option</th>
<th align="left">function</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">-R</td>
<td align="left">applied recursively</td>
</tr>
<tr>
<td align="center">-d</td>
<td align="left">sets default at directory, affects newly created files</td>
</tr>
<tr>
<td align="center">-m</td>
<td align="left">modify</td>
</tr>
<tr>
<td align="center">-x</td>
<td align="left">remove acl</td>
</tr>
</tbody>
</table><p>group:guests<br>
permissions:rwx<br>
directory: /storage/share<br>
<code>setfacl -Rdm g:guests:rwx /storage/share</code><br>
<code>setfacl -Rdm g:royalty:rwx /storage/share</code><br>
<strong>stackable</strong><br>
<code>setfacl -Rdm g:guests:rwx,g:royalty:rwx /storage/share</code><br>
<strong>alternate usage</strong><br>
<code>setfacl -Rm d:g:guests:rwx,g:royalty:rwx /storage/share</code></p>
<p><strong>set the file-level privileges [[does not affect directories, so newly created files will not heed ACL]]</strong><br>
<code>setfacl -Rm g:guests:rwx /storage/share</code><br>
<code>setfacl -Rm g:royalty:rwx /storage/share</code></p>
<p>[[maybe not needed]]<br>
<strong>recursively cd set (default) mask?</strong><br>
<code>setfacl -Rm d:m:rwx .</code><br>
<code>setfacl -Rm m:rwx .</code></p>
<p><strong>verify/view ACL’s</strong><br>
<code>getfacl /storage/share</code></p>
<p><strong>-x remove acl</strong><br>
<code>sudo setfacl -Rx d:g:guests /storage/workshop.kodi/</code> recursively remove ‘guests’ acl from directory<br>
<code>sudo setfacl -Rx g:guests /storage/workshop.kodi/</code> recursively remove ‘guests’ acl from files</p>
<h4 id="group-manipulation-notes">Group manipulation notes:</h4>
<p><strong>create the groups that we want, and append them to appropriate users</strong><br>
(specific gid not required)</p>
<pre><code>groupadd -g 1301 guests
groupadd -g 1302 royalty
groupadd -g 1303 builder
usermod -aG guests kodi
usermod -aG royalty cyril
</code></pre>
<p><strong>remove user from group</strong><br>
<code>usermod -G cyril,wheel cyril</code> #group for removal is omitted from list</p>
<p><strong>list all members of a group</strong><br>
<code>grep 'group-name-here' /etc/group</code></p>
<p><a href="https://www.tecmint.com/secure-files-using-acls-in-linux/">https://www.tecmint.com/secure-files-using-acls-in-linux/</a><br>
<a href="https://www.2daygeek.com/how-to-configure-access-control-lists-acls-setfacl-getfacl-linux/#">https://www.2daygeek.com/how-to-configure-access-control-lists-acls-setfacl-getfacl-linux/#</a><br>
<a href="https://www.geeksforgeeks.org/access-control-listsacl-linux/">https://www.geeksforgeeks.org/access-control-listsacl-linux/</a></p>
<p>Notes:<br>
nfs4</p>
<p>df -T showed me that the filesystem was mounted as nfs4 which apparently needs to be accessed from the client using nfs4_getfacl tools</p>
<p>[kodi@kodibox storage]$ sudo nfs4_setfacl -R -a A:dfg:builder:RWX workshop --test</p>
<p>decode this shit!<br>
<a href="https://www.osc.edu/book/export/html/4523">https://www.osc.edu/book/export/html/4523</a></p>
</div>
</body>

</html>
